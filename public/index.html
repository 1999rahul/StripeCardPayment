<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="base.css" />
    <title>Document</title>
  </head>
  <body>
    <div id="main">
      <div id="checkout">
        <div id="payment-form">
          <h1>Save Card Details</h1>
        </div>
        <fieldset>
          <label>
            <span>Name</span>
            <input
              id="cardholder-name"
              type="text"
              class="field"
              value="Rahul Kumar"
            />
          </label>
        </fieldset>
        <fieldset>
          <label>
            <div id="card-element" class="field"></div>
          </label>
        </fieldset>
        <button id="card-button">Save Card</button>
        <div id="card-message"></div>
      </div>
    </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      var setupIntent;
      debug("Fetching setup intent");
      fetch("/setup-intents")
        .then(function (r) {
          return r.json();
        })
        .then(function (response) {
          console.log(response);
          setupIntent = response;
          debug("Fetched setup intent: " + response.id);
        });

      var stripe = Stripe(
        "stripe publishable key"
      );

      var elements = stripe.elements();
      var cardElement = elements.create("card");
      cardElement.mount("#card-element");

    
      var cardholderName = document.getElementById("cardholder-name");
      var cardButton = document.getElementById("card-button");
     

      cardButton.addEventListener("click", function (ev) {
        ev.preventDefault();
        debug("handling card setup...");
        stripe
          .confirmCardSetup(setupIntent.client_secret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: cardholderName.value,
              },
            },
          })
          .then(function (result) {
            console.log(result);
            if (result.error) {
              debug(result.error.message);
              // Display error.message in your UI.
            } else {
              debug("Setup succeeded");
              debug(
                "Setup Intent Payment Method: " +
                  result.setupIntent.payment_method
              );
              // The setup has succeeded. Display a success message.
              createCustomer(result.setupIntent.payment_method);
            }
          });
      });

      function createCustomer(paymentMethod) {
        debug("Creating customer...");
        fetch("/create_customer", {
          method: "POST",
          body: JSON.stringify({
            payment_method: paymentMethod,
          }),
        })
          .then(function (r) {
            return r.json();
          })
          .then(function (response) {
            console.log(response);
            if (response.error) {
              debug(response.error.message);
            } else {
              debug("Created customer: " + response.id);
            }
          });
      }

      function debug(message) {
        var debugMessage = document.getElementById("card-message");
        console.log("DEBUG: ", message);
        debugMessage.innerText += "\n" + message;
      }
    </script>
  </body>
</html>
